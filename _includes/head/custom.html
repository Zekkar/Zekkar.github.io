<!-- 深色模式切換腳本 -->
<script src="{{ '/assets/js/theme-toggle.js' | relative_url }}" defer></script>

<!-- 防止閃爍：在頁面載入前先設定主題 -->
<script>
  (function() {
    var theme = localStorage.getItem('theme');
    if (theme) {
      document.documentElement.setAttribute('data-theme', theme);
    } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.setAttribute('data-theme', 'dark');
    }
  })();
</script>

<!-- Mermaid 圖表支援 -->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

  // 根據當前主題設定 Mermaid 主題
  function getMermaidTheme() {
    return document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default';
  }

  mermaid.initialize({
    startOnLoad: true,
    theme: getMermaidTheme(),
    securityLevel: 'loose',
    flowchart: {
      useMaxWidth: true,
      htmlLabels: true,
      curve: 'basis'
    }
  });

  // 監聽主題切換，重新渲染 Mermaid
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.attributeName === 'data-theme') {
        location.reload();
      }
    });
  });
  observer.observe(document.documentElement, { attributes: true });
</script>
